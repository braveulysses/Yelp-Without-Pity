<!DOCTYPE html>

<html>
<head>
<title>Yelp Without Pity</title>
<script type="text/javascript" charset="utf-8">
  var pop = new Audio("data:audio/mpeg,ID3%03%00%00%00%00%00%10TCON%00%00%00%06%00%00%00Blues%FF%FA%90%C0%AD%B7%00%00%16%06.%C2%19J%00%02%BB%3D%A0C%B50%01%F0%1A%26%01%80%3C0%A0%18%40~%06%2Cp%1B%A3%5E%07x%A0%19R%7F%88%40%16%18%1A%2F%F8%0A%0F%0B%8E%25%10%14%07%FF%80%C1q(%102d%93%FF%F2p%86%0E%91%1F%88%DC%90%FF%FC%83%87%3Cd%07%3Cd%D8%9F%FF%FF%C5%10%83%93%81%E2%10%60%B2%C2%D3%C5pv%7F%FF%FE(%10%CB%C0(%20%06%12%06%DE%25%01%94%1C%91%00%C9q%FF%FF%FF%FF%F19%8B%8C%94%1C%02%C0_P%C3%24Flu%8A%F0%5D%40%0D%00%14%9F%FF%FF%FF%FF%FF%FF%F8%D3%22%22%E3%402%E0b%D0%0E%1E%08%97%85%AC%80%11%B04%E0%C0%20%20%7D%03%BA%04B%01%9A%08%04%94%07h%03%82%1EEM4%12T%04X%18%C4%F0%C72%E2%CA%A8%8D%91%82%12%86p%C0%40T%2F%02%0E(%10%91b%01ER%A0%17B%22p%D0%DD%05)%16M%D6iR%15l_A%09%82%0AZ%0E%8E%A7N%82%D4f%A6%3A%EE%ED%A8%D1%94%9B%20%92%08%A9%95u%2FRn%82%DD%04%1DI%17%DBt%D1u%AD%D55t%DD%24%5D%92E%17N%CAY%82u%23Z5%24%8D%23z%96%EBA*Vz%D3%BAt%D3%A6%9B%B2%0B%A0%A5%BA%0F%B3%B2%15%26%A6ZGM%D2Ekei%E9%A9%D0EF%08Y%96%92%08%A9%14%90%A6%96%B5%A8%FAuVn%CE%CBH%F0%12%C3%8Dw%8F%1E%1A%17%16%80%04%03c%05%E0%3A0%AF%14%F3%06%91%052%F5%3D%B37%F2%E54%03G3RCV0%DBO%93vw%9F4%89(%83U%FF%FA%92%C0%EA%D9%15%83%D6%0D%E1%06%0Ftm%CA%C7%C1aA%FF%09%B9%23%E20%E10%F3%80%C5%83%3A%05sEN%D1A%C4%08)%18%20%10%81%84tLl%B1%EA%F3%152%E7p%E6%B9%BEc%BC%FF%2F%DF%3Fy%E5%BD%E1%86%1C%DE%1A%FF%E6x%7F%FEV%1D3%BEHZ%F7b%F3%BC%F3%2F3%86%A7%CF%E2%97%DB%CE%5C%BF%92%E5%A4%C8Ar%CA%D4%DDv%9Er%E6J%ADzn%8B3%D1%E5%14%92%5Dt%3C%AEd%D6%DB%E5%F0%D4%DF7%B4%ECV%976%23%98K%0BXi%A6%0E%00%95%A70n%D3%FC%A6%01%E0%02%2F%F0%80%06%83%01%E4%20%A3%08%BC%10%E3%00%FC%09%23%06%E4%1FC%04%FC%0F%D3%0AT5c%0C%88Vs)%08z%D3%0A%E0)c%0C%AD%00%23%24%94%E6%93%2Fx%8A%A3%A8%98%2F44%7B%23O%E2%060%93%04%A3%0B%E0%8C0%02%01r%D07%B4%D8%E5%DE%EBZ%EE%5C%E6%B1%FE%E2%E8%3F%17%AF%FE%1C%E7%FF%FE%7D%FE%FF7%AF%E6%DD%88%13%B8%C8S)o%7FFR%A1%11k%97%D6GTj%FB%E9%BB%19%3F%98%9C%BBU%D6%E8%F5%5E%EE%A8%A5%EDZ%CA%EC%DC%FB%F3%B5%AA%8E%FB%AASGu%7Fok%F7)%FB%A5%12%E7N%E6WJ%ADf%A1%E8%F6%BA%04E*T%CD%F0T%5E0%DDt1%047%05%13F%14%85%C6%2B%25%86%FC%D9G%22%10%26%18f%A8a%A4k%C6%A3%EDD%60%06o%A6f%03%AAa%0E%2Ff%AD%8B%8Ee%EC%25%A6%13%A2(b2%04%86%10%40%9A%17%00%E5%F7%06M%CCg%DA%9C%AEpr%1A%2B%A9%020%14%FF%FA%92%C0%9B%F0)%83%D4T%85%0A%0E%F9%A9B%BE%95%60%C1%BE%CD1r%40%D1%25)%06Z%D7%5E%B5n%A5%878Nb%88%20%22'%10%1B%15SP%C8%04%80%FB%F1%F3%0C%8E%0C%E1%C6l%12%26%E8%A3%A9%20%9B%25%06%8E%9E%26ah%81%94%C2a%D4(%F8%AB%01%B8%B5*%07%D8%E6%0Fx8%2C%2F%B0%1A%9AHL%C2%5C%F0%EA%B0%5Bi%26%C4v%0A%D62%82rc%B3%7B%C66%3A%93%0F84%8Cz1%85%23%3E%D8p1%89%1A5%7C%8F4Q%3F1%40%9C1%D0%070%D4%2B%03%04%A0%A0%B9Ma%EB5%B9%96%13%60%90%1D%7B%2Ce%17%93%D6%C2%BA%01%C4%07%B8%18%A8%0B%AC%06%04%1E%03%E7%0D%05%CEj%D5%D7Yy%05%24%82f%C2%12%0C%DA%13%DA%D0%B2'l%B52%AA%3Dr%93d%B3%F3%BB%8A4_%93%DEF%0Ed%84%F4%E4%ED%D78G(%89-0%13B%D5%23U%A9%11%19%0AW%5Ba%CAT%F7~%99%BCp%D3%A92j%8A%EC%A7%F2%9CK%AE(B%CBv%22bp%89%7C%C0%08jV%9B(r%0B%89%85Ac%20%C2Q%19%83%80%C6%26%07%19x%14f%84%09%97%0F%26%60x%1CP%D0%04%03%99%9B%D9%A2%9B%98%92%C0%8D%DC%0E%2C%18%07I%9F%E1%8ET%CE%08%A9y%B7%D1%9C%AA%F8%B1T%3DK%8EV%20%F4%2CoA%C3f%12%02%CD%7Fl%20%CD%82%A19~%18%F7%BA%C3x%F7%5B%EA%B2%2B%5Ey%5D%A4s%AD%24fw%ED%A2OOvk%EC%9EtuWS%EF%AB5%0CZ%99%90%AEw%92%9E%86)U%E5Z%D5K%EF%A9%25%82%FF%FA%92%C0M%EDE%83%D5%11c%08%0ElM%CA%B4%3F%60%C1%BD%8D%B9%A3%D1%A6%FA%95%B1S%B74%F6%0B%DD%3F%D6%EB%10%0Fm%BB%8Eb%02%AD%8C%F3%D5%AA%C7%D9G%B6%A3%03.%E9%7F%8C%84(%04%02%AC%86b8V%18%60!Ihd%A6%E7%B8%EAe%EC%C0-%F3P%871%80%92%C3%09%EC%22%0B%09%DC%BDCK%8Ff%A0%D00I%AA%DB%02%09%C0%CC%F1%89%BC%AE%5D_(%F2%DF%08%40P%937%8C%CA%99%18%08%FC%0D%8E%B9%973%CB%F9%F9%F7%97%D8S%BD%9Ee%15%A5%F5%FBa%BD%F38%E6%F94%99k%9A%3B%E9%B6Y%12%AE%8F%3D%A5%20o%B6M%FFJ%19%D6'%BC6N%95%F8E!%E6%C6%B3%FD%FASGv%E2E)%EEi%5D%EE%88Mr%3C%B5.%91%BB%1B%AD%9F%0B%1D%D3%1C%F3M%90%9EMb%03%5E%D2%01%BA%9D%BATZ%96%20%99M%DAd%00%98%00%A2%BD%88%A2tI%E1%C9%BA%83%A2D%06%8Dd%1A%88%B2uF%F5%F55ff%1E%25%1E%3A%D0c8%26%07!Fcy%FF%D8%7C%A1%F0%A82%7COr%85%F5%10%02%3E%7C%DF7%97%3B%F8w%9C%CB%B7(%BF%FF%0EwYs%0C%7B%F9n%C0W%81m%A0%C7%8F%A9%AF%FD8%D0%CA%FF%96%FB%EC%05%1F%1E.%C2%F0%F4%7F%60%FA%10%E5%EF%81%BE%C8%09%9B%15%08%C3%BB%EB%CD%CB%8B%F5%8C%CAB%2B%EB%E5F8%1F%B5%EAC%AB%A8x%5B%EFy%F7%DE%3F%8B%0A%14%04%C8%1B%E3%9AH%87%B0%0De%AD%97aJ%0D%1A%5B5%10%A8%C1A%B0%C1%0A%1D%CA%C0hs1%B0%C0%00%15%11%01%FF%FA%92%C0%CD%D1%60%00%13%0C%A3%08%15%8D%80%0C9E%E0%C39%90%00t%C0%7C%CDp%EB%05%97)c7%40%F0%5E%020%16%10T%BD%9A%23%06c%81%C6F%D9%D2P%95%9C%10%90%92%A6In%9B%E5W%0BtR%D9%7D%FD%9EC2%B4%24%03%A7%005z%97%F9%9Er%B8%3F%0C%F2%AAo%0CH%008E4%0C%3E%83z%D6%3C%EEW%7B%BC%F2%9A%FCh%AD%CCE%9F%CA%FB%BB%9D%9DW%FDo%0D~w0%D7%2F%C8e%F5%24R%CA%F0%98n%E5%DD%D9%B5%7F%959%CDo%F1%B1%8Fq%FE%D7%B9%9C%8AY%9D%14N%E5%1D%8EHc%7D%D72%AB%FC%C3yg%F73%D6%F2%AD%F8a%ADa%96%3F%CD%E5rO%2C%AB%3B%1B%C2GI%C9%C8%DETq%8D%E3w%9F%8F2%C7u%B1%B1%9E%F3%DF%E5%FF%FF%FF%FF%FA%CF%B7%F3%CA%CF%2B%EF%B9V%CBv7g%FF%FF%FF%FF%FF%E4%11%3C%A5%F4%18NM%F6%8E%A5%2C%A2%9E%DC%8EQ%8D%3AI%F3%08D4%F4s%22%13%0A%26%99x%60%E8J%12K%01H~%17%18%07%07%86A%19%80%D8%D0%890a%88%0E%88EY%89%BC%89%D4%D9%A4%8Ct%B6!%25%18%04%970yw%B8%141%90%AC%25y%88%0A%401%8A9t%0C%14%1C%24%3A%06%00%5BD70C%03%16%D7%06GS%10H%8A%C6%87%15%86%1A%3C%98%84%CEp%12%E0%0C%E2J%22x%84W-s%A7%1B%A4%E2%26j%CDk%D0%12%DAf%0E%BDg%82%8Ar%2FAn%A5%7BY%97%805%0E%D2%B5%FFSnK%FD%0BEHK%D6%DBS%A7C%F8%85%D4%1D%BB%F6%DB%FF%FA%92%C0_%F5R%03%D5%90%A9%0E%1D%BC%80%03t%20%E2%01%BCaq%9E%18%88%B9%EDVt%DA%93%96%CB5%83%B3%04%060%E0%13%09%17%16i%5Df%12%10%D6%60%B0%80%D1%E0%20%82%ABq%85%05%D2-%93w%5E*%CC2%10%17Dj9%91%7F%03%0A%99%B3p%12b%98D%08%5B%15a%0A%BC%B8(%02%9F%0B%1D0%23h%AC%DD%90Y%06W%7B8K%E4%EFf%A0%40%B4%85.w%1A%8AJ%97%C5%06%89J%A1%10%0B%AA%EB%AE%F5(VV%B2%CE%13%26%1D%5E%AF%ABY%8F%C3%95%E0%99%C8v%BD%C9%E9%CA%1BR%C9%BC%A9%2B%D9%A7%A9f%9E%A64%F5-X%AF%95%25~%D2W%B3n%E5%9Az%98%E7%ABU.%F7%0B%BD%B1%9F3%D7-%C8Y%24%E4RLY%1C%85%92NE%24%C5%91%C8Y%24%E4C%26%2C%8Cad%93%91I0r9%0FI%1C%05%24B%C0x%07%24%16%02%19%81%E4FNY%18%0AL'%03%C2u3h2I%0C%B4%C7%10p%14%E8K%A5%01cN%E3%26pD%03%E6Z%8C%ABc%8D%15%40%26%04FE%03%C1%90%B1R%03fP%96.8%1A%10%94%3ECs%12%B2%F2%C9(%EC%B2!%17%08%C2Ip%D8%92%5C%1F%80H%D2%2C%0A%83%92%40%FC%24%A4Tt%DCK%A1uu%DDe%87%96%B0%F2%DA%3C%D5%DD%5D%0B%AD%5D%D6h%F34y%9A%3C%D5%DDj%EE%B5z%D6%96f%81%20A%60%C1%A1%60%A0%40%81(%A5%06%0D%1AM%10%20J)A%83e%26%8Ab%A8%A5%24%96Rh%A6*%8ARIe%26%8Ab%A8%A5%24%96Rh%A6*%8A%FF%FA%92%C0%FC%ECR%83%D6%0C%F5%02%0C%A5%8B%88%00%004%80%00%00%00RIe%26%8Ab%A8%A5%24%96%14%EALAME3.93%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA%AA");
  
  /*
   * When passed as a transaction error handler, this will cause the 
   * transaction to fail with a warning message.
   */
  function errorHandler(transaction, error) {
    console.log("Yelp Without Pity settings error: " + error.message + ", " + error.code);
    return true;
  }
  
  /*
   * This is used as a data handler for a request that returns no data.
   */
  function nullDataHandler(transaction, results) {}
  
  /*
   * Returns an instance of the settings database.
   */
  function getSettingsDatabase() {
    try {
      var shortName = "yelpWithoutPityDB";
      var version = "1.0";
      var displayName = "Yelp Without Pity Settings Database";
      var maxSize = 65536;
      var db = openDatabase(shortName, version, displayName, maxSize);
      return db;
    } catch (e) {
      if (e == 2) {
        console.log("Invalid Yelp Without Pity settings DB version.");
      } else {
        console.log("Unknown error opening Yelp Without Pity settings DB: " + e);
      }
      return;
    }
  }
  
  /*
   * Creates the blocked users table if it doesn't already exist.
   */
  function initSettingsDatabase() {
    var db = getSettingsDatabase();
    db.transaction(
      function(transaction) {
        transaction.executeSql(
          'CREATE TABLE IF NOT EXISTS blockedUsers(name TEXT NOT NULL PRIMARY KEY);',
          [],
          nullDataHandler,
          errorHandler
        );
      }
    );
  }
  
  /*
   * Gets the list of blocked users from the settings database.
   */
  function getBlockedUsers() {
    var db = getSettingsDatabase();
    var blockedUsers = [];
    db.transaction(
      function(transaction) {
        transaction.executeSql(
          "SELECT * FROM blockedUsers;",
          [],
          function(transaction, results) {
            for (var i=0; i < results.rows.length; i++) {
              blockedUsers.push(results.row.item[i]);
            }
          },
          errorHandler
        );
      }
    );
    return blockedUsers;
  }
  
  /*
   * Adds a blocked user to the settings database.
   */
  function addBlockedUser(username) {
    var db = getSettingsDatabase();
    db.transaction(
      function(transaction) {
        transaction.executeSql(
          "INSERT INTO blockedUsers (name) VALUES (?);",
          [ username ],
          nullDataHandler,
          errorHandler
        );
      }
    );
  }
  
  /*
   * Handles messages from the inject script.
   */
  function handleMessages(event) {
    switch (event.name) {
      case "getYelpWithoutPitySettings":
        console.log("Dispatching list of blocked users to inject script");
        var blockedUsers = getBlockedUsers();
        event.target.page.dispatchMessage("yelpWithoutPitySettings", {
          blockedUsers: safari.extension.settings.blockedUsers
        });
        break;
      case "saveYelpWithoutPitySettings":
        console.log("Saving blocked user " + event.message);
        addBlockedUser(event.message);
        break;
      case "makePopSound":
        console.log("Playing pop sound");
        pop.play();
        break;
    }
  }
  
  initSettingsDatabase();
  safari.application.addEventListener("message", handleMessages, false);
</script>
</head>
</html>
